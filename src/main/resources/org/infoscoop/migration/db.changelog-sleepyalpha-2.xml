<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="clob.type" value="clob" dbms="oracle, db2"/>
    <property name="clob.type" value="mediumtext" dbms="mysql"/>
    <property name="autoIncrement" value="true" dbms="mysql, db2"/>
    <property name="autoIncrement" value="false" dbms="oracle"/>

    <!--Issue 609-->
    <changeSet id="infoscoop_sleepyalpha2_609_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_1">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="default_belong_id"/>
        </preConditions>
        <dropColumn columnName="default_belong_id"  schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS"/>
        <dropColumn columnName="belong_id"  schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS"/>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_2" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_2">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="default_square_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS">
            <column name="default_square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="false"/>
            </column>
            <column name="given_name" type="varchar(128)"/>
            <column name="family_name" type="varchar(128)"/>
            <column name="email" type="varchar(150)"/>
        </addColumn>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_3" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_3">
            <not>
                <tableExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_ATTRS"/>
                <tableExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_SQUARES"/>
            </not>
        </preConditions>
        <createTable tableName="IS_ACCOUNT_ATTRS" tablespace="${.tablespace}">
            <column name="id" type="int" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="fk_account_id" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="${clob.type}"/>
        </createTable>
        <createTable tableName="IS_ACCOUNT_SQUARES" tablespace="${.tablespace}">
            <column name="id" type="int" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="fk_account_id" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="square_id" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_4" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_4">
            <not>
                <indexExists indexName="is_account_attrs_name_idx"/>
            </not>
        </preConditions>
        <createIndex indexName="is_account_attrs_name_idx" schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_ATTRS" tablespace="${.tablespace}">
            <column name="name" type="varchar(255)"/>
        </createIndex>
        <createIndex indexName="is_account_squares_square_idx" schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_SQUARES" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="fk_account_id" baseTableName="IS_ACCOUNT_ATTRS" constraintName="fk_is_account_attrs_uid" onDelete="CASCADE" referencedColumnNames="uid" referencedTableName="IS_ACCOUNTS"/>
        <addForeignKeyConstraint baseColumnNames="fk_account_id" baseTableName="IS_ACCOUNT_SQUARES" constraintName="fk_is_account_squares_uid" onDelete="CASCADE" referencedColumnNames="uid" referencedTableName="IS_ACCOUNTS"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_ACCOUNT_SQUARES" constraintName="fk_is_account_squares_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="IS_SQUARES"/>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_5" author="aknishiumi" dbms="oracle">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_5">
            <not>
                <sequenceExists sequenceName="is_account_attrs_id_seq" schemaName="${migration.defaultSchema}"/>
                <sequenceExists sequenceName="is_account_squares_id_seq" schemaName="${migration.defaultSchema}"/>
            </not>
        </preConditions>
        <createSequence sequenceName="is_account_attrs_id_seq" schemaName="${migration.defaultSchema}"/>
        <createSequence sequenceName="is_account_squares_id_seq" schemaName="${migration.defaultSchema}"/>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_6" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_6">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="my_square_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS">
            <column name="my_square_id" type="varchar(64)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_609_7" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_609_6">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="my_square_id"/>
        </preConditions>
        <sql><![CDATA[
UPDATE ${migration.defaultSchemaWithDot}IS_ACCOUNTS SET my_square_id=uid WHERE my_square_id = '' or my_square_id is NULL
        ]]></sql>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_610" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_610">
            <primaryKeyExists schemaName="${migration.defaultSchema}" tableName="IS_OAUTHPROVIDER_CLIENT" primaryKeyName="PRIMARY"/>
        </preConditions>
        <dropPrimaryKey schemaName="${migration.defaultSchema}" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_CLIENT"/>
        <dropPrimaryKey schemaName="${migration.defaultSchema}" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_ACCESSTOKENS"/>
        <dropPrimaryKey schemaName="${migration.defaultSchema}" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_REFRESHTOKENS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_CLIENT"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_ACCESSTOKENS"/>
        <addPrimaryKey schemaName="${migration.defaultSchema}" columnNames="id" constraintName="PRIMARY" tableName="IS_OAUTHPROVIDER_REFRESHTOKENS"/>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_611_1" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_611">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_PORTALLAYOUTS" columnName="advanced"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_PORTALLAYOUTS">
            <column name="advanced" type="integer" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_611_2" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_611_2">
            <columnExists schemaName="${migration.defaultSchema}" tableName="IS_PORTALLAYOUTS" columnName="advanced"/>
        </preConditions>
        <update tableName="IS_PORTALLAYOUTS">
            <column name="advanced" value="1"/>
            <where>name='javascript' or name='css'</where>
        </update>
    </changeSet>

   <changeSet id="infoscoop_sleepyalpha2_611_3" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_611_3">
            <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='alb_notSupportedMessage';</sqlCheck>
        </preConditions>
        <insert tableName="IS_I18N">
            <column name="type" value="adminjs" />
            <column name="id" value="alb_notSupportedMessage" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="It isn't supported about the setting item of the red character. When editing, there is a possibility that a product doesn't move any more." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="adminjs" />
            <column name="id" value="alb_notSupportedMessage" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="赤字の設定項目に関してはサポート対象外となります。編集した場合、製品が正しく動作しなくなる可能性があります。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="adminjs" />
            <column name="id" value="alb_notSupportedMessage" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="有关红文字的设定项目不被支持。如果编辑，有产品变得不做动作的可能性。" />
            <column name="square_id" value="default" />
        </insert>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_612_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_612_1">
            <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='lb_error_max_square';</sqlCheck>
        </preConditions>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_error_max_square" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="Square created the number has reached the upper limit." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_error_max_square" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="スクエア作成数が上限に達しました。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_error_max_square" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="广场创建的数量已经达到上限" />
            <column name="square_id" value="default" />
        </insert>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_612_2" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_612_2">
            <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='lb_square_maxuser';</sqlCheck>
        </preConditions>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="Reached the number of users upper limit of the Square." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="スクエアのユーザ数上限に達しました。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="达到的广场用户上限数。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser_desc" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="Because it has reached the upper limit of the number of users who can belong to the Square, it will not be able to participate." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser_desc" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="スクエアに所属できるユーザ数の上限に達したため、参加することができません。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_square_maxuser_desc" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="因为它已经达到谁可以属于广场的用户数量的上限，它将不能够参加员。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_call_square_admin" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="Please contact your Square administrator." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_call_square_admin" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="スクエア管理者にお問い合わせ下さい。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_call_square_admin" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="请联系您的广场管理员。" />
            <column name="square_id" value="default" />
        </insert>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_598_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_598_1">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_SQUARES" columnName="parent_square_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_SQUARES">
            <column name="parent_square_id" type="varchar(64)" defaultValue="default">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <createIndex indexName="is_squares_parent_square_id_idx" schemaName="${migration.defaultSchema}" tableName="IS_SQUARES" tablespace="${.tablespace}">
            <column name="parent_square_id" type="varchar(64)"/>
        </createIndex>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_598_2" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_598_2">
            <sqlCheck expectedResult="default">select parent_square_id from ${migration.defaultSchemaWithDot}IS_SQUARES where id='default';</sqlCheck>
        </preConditions>
        <update schemaName="${migration.defaultSchema}" tableName="IS_SQUARES">
            <column name="parent_square_id" type="varchar(64)"/>
            <where>id='default'</where>
        </update>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha2_615_1" author="y.momose">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_615_1">
            <not>
              <tableExists schemaName="${migration.defaultSchema}" tableName="IS_PRINCIPALS"/>
            </not>
        </preConditions>
        <createTable tableName="IS_PRINCIPALS">
            <column name="id" type="int" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="account_attr_name" type="${clob.type}">
                <constraints nullable="false"/>
            </column>
            <column name="square_id" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>
