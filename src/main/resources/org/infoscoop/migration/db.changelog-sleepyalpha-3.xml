<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="clob.type" value="clob" dbms="oracle, db2"/>
    <property name="clob.type" value="mediumtext" dbms="mysql"/>
    <property name="autoIncrement" value="true" dbms="mysql, db2"/>
    <property name="autoIncrement" value="false" dbms="oracle"/>

<changeSet id="infoscoop_sleepyalpha3_624" author="aknishiumi">
  <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_624">
      <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='lb_server_updated_reload' and type='js';</sqlCheck>
  </preConditions>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_server_updated_reload" />
    <column name="country" value="ALL" />
    <column name="lang" value="ALL" />
    <column name="message" value="System maintenance was performed. Refreshment of a page is needed. Updated information on this browser is not sended to the server." />
    <column name="square_id" value="default" />
  </insert>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_server_updated_reload" />
    <column name="country" value="ALL" />
    <column name="lang" value="ja" />
    <column name="message" value="システムメンテナンスが行われたため、ページの再読み込みが必要です。このブラウザ上の更新情報は反映されません。" />
    <column name="square_id" value="default" />
  </insert>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_server_updated_reload" />
    <column name="country" value="ALL" />
    <column name="lang" value="zh" />
    <column name="message" value="保养被进行了。在此浏览器上的更新信息没有得到反映。" />
    <column name="square_id" value="default" />
  </insert>
  <update tableName="IS_I18N" schemaName="${migration.defaultSchema}">
    <column name="message" value="Failed to save the customized information. Please reload a browser. Updated information on this browser is not sended to the server." />
    <where>id='ms_custmizeFailedReload' AND lang='ALL'</where>
  </update>
  <update tableName="IS_I18N" schemaName="${migration.defaultSchema}">
    <column name="message" value="カスタマイズ情報の保存に失敗しました。ブラウザの再ロードを行ってください。このブラウザ上の更新情報は反映されません。" />
    <where>id='ms_custmizeFailedReload' AND lang='ja'</where>
  </update>
  <update tableName="IS_I18N" schemaName="${migration.defaultSchema}">
    <column name="message" value="自定义信息保存失败。请进行浏览程序的再读入。在此浏览器上的更新信息没有得到反映。" />
    <where>id='ms_custmizeFailedReload' AND lang='zh'</where>
  </update>
</changeSet>

    <changeSet id="infoscoop_sleepyalpha3_598_4" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_598_4">
            <not>
                <tableExists schemaName="${migration.defaultSchema}" tableName="IS_SQUARE_ALIASES"/>
            </not>
        </preConditions>
        <createTable tableName="IS_SQUARE_ALIASES" tablespace="${.tablespace}">
            <column name="id" type="int" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="square_id" type="varchar(64)">
                <constraints nullable="true"/>
            </column>
            <column name="system" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_598_5" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha2_598_5">
            <not>
                <indexExists indexName="is_square_aliases_name_idx"/>
            </not>
        </preConditions>
        <createIndex indexName="is_square_aliases_name_idx" schemaName="${migration.defaultSchema}" tableName="IS_SQUARE_ALIASES" tablespace="${.tablespace}">
            <column name="name" type="varchar(255)"/>
        </createIndex>
		<addUniqueConstraint columnNames="name" constraintName="is_square_aliases_name_unique" schemaName="${migration.defaultSchema}" tableName="IS_SQUARE_ALIASES" tablespace="${.tablespace}"/>
        <addForeignKeyConstraint baseColumnNames="square_id" baseTableName="IS_SQUARE_ALIASES" constraintName="fk_is_square_aliases_squares_id" onDelete="CASCADE" referencedColumnNames="id" referencedTableName="IS_SQUARES"/>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_598_6" author="aknishiumi" dbms="oracle">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_598_6">
            <not>
                <sequenceExists sequenceName="is_square_aliases_id_seq" schemaName="${migration.defaultSchema}"/>
            </not>
        </preConditions>
        <createSequence sequenceName="is_square_aliases_id_seq" schemaName="${migration.defaultSchema}"/>
    </changeSet>

<changeSet id="infoscoop_sleepyalpha3_598_6" author="aknishiumi">
  <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_598_1">
      <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='lb_invalid_parameter' and type='js';</sqlCheck>
  </preConditions>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_invalid_parameter" />
    <column name="country" value="ALL" />
    <column name="lang" value="ALL" />
    <column name="message" value="Invalid Parameter." />
    <column name="square_id" value="default" />
  </insert>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_invalid_parameter" />
    <column name="country" value="ALL" />
    <column name="lang" value="ja" />
    <column name="message" value="パラメータが不正です。" />
    <column name="square_id" value="default" />
  </insert>
  <insert tableName="IS_I18N">
    <column name="type" value="js" />
    <column name="id" value="lb_invalid_parameter" />
    <column name="country" value="ALL" />
    <column name="lang" value="zh" />
    <column name="message" value="参数不正当。" />
    <column name="square_id" value="default" />
  </insert>
</changeSet>

    <changeSet id="infoscoop_sleepyalpha3_619_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_619_1">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_ATTRS" columnName="square_id"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_ATTRS">
            <column name="square_id" type="varchar(64)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <createIndex indexName="is_account_attrs_square_id_idx" schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNT_ATTRS" tablespace="${.tablespace}">
            <column name="square_id" type="varchar(64)"/>
        </createIndex>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_598_7" author="aknishiumi">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_598_7">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_SQUARES" columnName="permission"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_SQUARES">
            <column name="permission" type="varchar(256)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_598_8" author="mikami">
    <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_598_8">
        <sqlCheck expectedResult="0">select count(*) from ${migration.defaultSchemaWithDot}IS_I18N where id='lb_account_setting_attribute' and type='js';</sqlCheck>
    </preConditions>
    <insert tableName="IS_I18N">
        <column name="type" value="js" />
        <column name="id" value="lb_account_setting_attribute" />
        <column name="country" value="ALL" />
        <column name="lang" value="ALL" />
        <column name="message" value="Account attributes" />
        <column name="square_id" value="default" />
    </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_account_setting_attribute" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="アカウント情報" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="lb_account_setting_attribute" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="帐户属性" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="ms_change_relogin_apply" />
            <column name="country" value="ALL" />
            <column name="lang" value="ALL" />
            <column name="message" value="Changes will be applied after login again." />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="ms_change_relogin_apply" />
            <column name="country" value="ALL" />
            <column name="lang" value="ja" />
            <column name="message" value="変更は再ログイン後に適用されます。" />
            <column name="square_id" value="default" />
        </insert>
        <insert tableName="IS_I18N">
            <column name="type" value="js" />
            <column name="id" value="ms_change_relogin_apply" />
            <column name="country" value="ALL" />
            <column name="lang" value="zh" />
            <column name="message" value="更改将登录后再次使用。" />
            <column name="square_id" value="default" />
        </insert>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_619_2" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_619_2">
            <not>
                <columnExists schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS" columnName="require_password_reset"/>
            </not>
        </preConditions>
        <addColumn schemaName="${migration.defaultSchema}" tableName="IS_ACCOUNTS">
            <column name="require_password_reset" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="infoscoop_sleepyalpha3_1076_1" author="mikami">
        <preConditions onFail="MARK_RAN" onFailMessage="skip infoscoop_sleepyalpha3_1076_1">
            <foreignKeyConstraintExists foreignKeyName="fk_is_oauth_gadget_urls_fk_oid" schemaName="${migration.defaultSchema}"/>
            <foreignKeyConstraintExists foreignKeyName="fk_is_oauth2_fk_oid" schemaName="${migration.defaultSchema}"/>
            <foreignKeyConstraintExists foreignKeyName="fk_is_oauth_fk_oid" schemaName="${migration.defaultSchema}"/>
        </preConditions>
        <dropForeignKeyConstraint baseTableName="IS_OAUTH_GADGET_URLS" baseTableSchemaName="${migration.defaultSchema}" constraintName="fk_is_oauth_gadget_urls_fk_oid"/>
        <dropForeignKeyConstraint baseTableName="IS_OAUTH_TOKENS" baseTableSchemaName="${migration.defaultSchema}" constraintName="fk_is_oauth_fk_oid"/>
        <dropForeignKeyConstraint baseTableName="IS_OAUTH2_TOKENS" baseTableSchemaName="${migration.defaultSchema}" constraintName="fk_is_oauth2_fk_oid"/>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id, square_id" baseTableName="IS_OAUTH_GADGET_URLS" constraintName="fk_is_oauth_gadget_urls_fk_oid" onDelete="CASCADE" referencedColumnNames="id, square_id" referencedTableName="IS_OAUTH_CONSUMERS"/>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id, square_id" baseTableName="IS_OAUTH_TOKENS" constraintName="fk_is_oauth_fk_oid" onDelete="CASCADE" referencedColumnNames="id, square_id" referencedTableName="IS_OAUTH_CONSUMERS"/>
        <addForeignKeyConstraint baseColumnNames="fk_oauth_id, square_id" baseTableName="IS_OAUTH2_TOKENS" constraintName="fk_is_oauth2_fk_oid" onDelete="CASCADE" referencedColumnNames="id, square_id" referencedTableName="IS_OAUTH_CONSUMERS"/>
    </changeSet>

</databaseChangeLog>
